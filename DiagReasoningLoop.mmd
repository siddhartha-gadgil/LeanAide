graph TD
    A[Start: Receive Problem Statement] --> B{Problem Deconstruction & Formalization};

    %% Phase 1: Problem Deconstruction & Formalization
    B --> B1[Structured Analysis];
    B1 --> B2[Definition Expansion];
    B2 --> B3[Rephrasing and Intuition];
    B3 --> C{Problem Inspection: Triage};

    %% Phase 2: Problem Inspection (Triage)
    C -- "Study Sources Needed?" --> D{Source Material Analysis};
    C -- "Direct Proof Viable?" --> E{Strategy & Plan Generation};

    %% Phase 3: Source Material Analysis (Loop)
    D --> D1["Listing & Extracting Theorems (from {{source_material_full_text}})"];
    D1 -- "For each relevant theorem" --> D_Loop[Loop: Study Theorem Deeply];
    D_Loop --> D2[Structural Mapping];
    D2 --> D3[Hypothesis Stress-Testing];
    D3 --> D4[Generalization & Boundary Probing];
    D4 --> D5[Core Idea Extraction];
    D_Loop --> E; 

    %% Phase 4: Strategy & Plan Generation
    E --> E1[Forward Reasoning];
    E1 --> E2[Backward Reasoning];
    E2 --> E3[Technique Brainstorming];
    E3 --> E4[Simplification & Specialization];
    E4 --> E5["Proof Sketch & Auxiliary Questions (label steps: easy, standard, hard)"];
    E5 --> F{Execution Loop};

    %% Execution Loop (F)
    F --> F_start(Loop: Execute Current Plan Step-by-Step);
    F_start --> F1[Single Step Execution];
    F1 -- "Step is 'hard'?" --> F_Rec{Recursive Call};
    F_Rec -- "Yes" --> B; 
    F_Rec -- "No (easy/standard)" --> F2[Formal Justification];
    F2 --> F3[Maintaining State, Summarization];
    F3 --> G{Verification & Critical Analysis};

    %% Phase 5: Verification & Critical Analysis
    G --> G1["The Skeptic's Hat"];
    G1 --> G2[Sanity Checks and Edge Cases];
    G2 --> G3["Formalization in Lean & Feedback (Background Process)"];
    G3 --> H{Meta-cognition & Loop Control};

    %% Phase 6: Meta-cognition & Loop Control
    H --> H1[Progress Analysis];
    H1 --> H2[Identifying Bottlenecks];
    H2 --> H3{Next Step Decision};
    H3 -- "Refine plan & continue" --> F_start;
    H3 -- "Strategy Pivot (select new plan)" --> E;
    H3 -- "Change main goal" --> B;
    H3 -- "Proof Complete / Abandon" --> Z[End];

    %% Lean as a background process (Dashed for continuous/non-blocking)
    style G3 fill:#f9f,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5;